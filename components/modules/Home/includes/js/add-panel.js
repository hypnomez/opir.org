// Generated by CoffeeScript 1.4.0
(function() {

  $(function() {
    var add_event_coords, addition_editing_panel, address_timeout, category, coords, edit_data, event_coords, map_cursor, panel, put_events_coords, reset_options, time, time_interval, timeout, uploader, urgency, visible;
    panel = $('.cs-home-add-panel');
    category = 0;
    visible = 2;
    urgency = 'urgent';
    time = 15;
    time_interval = 60;
    timeout = time * time_interval;
    coords = [0, 0];
    event_coords = null;
    put_events_coords = false;
    map_cursor = null;
    edit_data = 0;
    address_timeout = 0;
    uploader = null;
    reset_options = function() {
      visible = 2;
      urgency = 'urgent';
      time = 15;
      time_interval = 60;
      timeout = time * time_interval;
      coords = [0, 0];
      event_coords && map.geoObjects.remove(event_coords);
      event_coords = null;
      map_cursor && map_cursor.remove();
      map_cursor = null;
      put_events_coords = false;
      uploader && uploader.destroy();
      return uploader = null;
    };
    $(document).on('click', '.cs-home-add, .cs-home-add-close', function() {
      reset_options();
      return panel.html('').toggle('fast', function() {
        var content, id, _ref;
        if (panel.css('display') !== 'none') {
          content = '';
          _ref = cs.home.categories;
          for (id in _ref) {
            category = _ref[id];
            content += "<li data-id=\"" + id + "\">\n	<img src=\"/components/modules/Home/includes/img/" + id + ".png\" alt=\"\">\n	<span>" + category + "</span>\n</li>";
          }
          return panel.html("<ul>" + content + "</ul>");
        }
      });
    });
    add_event_coords = function(point) {
      coords = point;
      event_coords && map.geoObjects.remove(event_coords);
      event_coords = new ymaps.Placemark(coords, {}, {
        draggable: true,
        iconLayout: 'default#image',
        iconImageHref: '/components/modules/Home/includes/img/new-event.png',
        iconImageSize: [91, 86],
        iconImageOffset: [-36, -86]
      });
      map.geoObjects.add(event_coords);
      return event_coords.events.add('geometrychange', function(e) {
        return coords = e.get('originalEvent').originalEvent.newCoordinates;
      });
    };
    (function() {
      var map_init;
      map_init = setInterval((function() {
        if (!window.map || !map.events) {
          return;
        }
        clearInterval(map_init);
        map.events.add('click', function(e) {
          if (!put_events_coords) {
            return;
          }
          return add_event_coords(e.get('coords'));
        });
      }), 100);
    })();
    addition_editing_panel = function() {
      var $this, content, edit, name, submit;
      $this = $(this);
      edit = $this.hasClass('cs-home-edit');
      if (edit) {
        submit = "<button class=\"cs-home-edit-process\">Зберегти</button>";
        name = cs.home.categories[edit_data.category];
      } else {
        category = $this.data('id');
        submit = "<button class=\"cs-home-add-process\">Додати</button>";
        name = $this.find('span').text();
      }
      content = ("<h2>" + name + "</h2>\n<textarea placeholder=\"Коментар\"></textarea>\n<button class=\"cs-home-add-image-button uk-icon-picture-o\"> Додати фото</button>\n<div data-uk-dropdown=\"{mode:'click'}\" class=\"uk-button-dropdown\">\n	<button type=\"button\" class=\"uk-button\">\n		<span class=\"uk-icon-caret-down\"></span> <span>Моїй групі активістів</span>\n	</button>\n	<div class=\"uk-dropdown\">\n		<ul class=\"cs-home-add-visible uk-nav uk-nav-dropdown\">\n			<li class=\"uk-nav-header\">Кому відображати</li>\n			<li data-id=\"2\">\n				<a>Моїй групі активістів</a>\n			</li>") + ("<li data-id=\"0\">\n				<a>Всім</a>\n			</li>\n		</ul>\n	</div>\n</div>\n<div data-uk-dropdown=\"{mode:'click'}\" class=\"uk-button-dropdown\">\n	<button type=\"button\" class=\"uk-button\">\n		<span class=\"uk-icon-caret-down\"></span> <span>Терміново</span>\n	</button>\n	<div class=\"uk-dropdown\">\n		<ul class=\"cs-home-add-urgency uk-nav uk-nav-dropdown\">\n			<li class=\"uk-nav-header\">Терміновість</li>\n			<li data-id=\"urgent\">\n				<a>Терміново</a>\n			</li>\n			<li data-id=\"can-wait\">\n				<a>Може почекати</a>\n			</li>\n			<li data-id=\"unknown\">\n				<a>Не вказано</a>\n			</li>\n		</ul>\n	</div>\n</div>\n<h3 class=\"cs-home-actuality-control\">Актуально протягом</h3>\n<div class=\"cs-home-actuality-control\">\n	<input class=\"cs-home-add-time\" type=\"number\" min=\"1\" value=\"15\"/>\n	<div data-uk-dropdown=\"{mode:'click'}\" class=\"uk-button-dropdown\">\n		<button type=\"button\" class=\"uk-button\">\n			<span class=\"uk-icon-caret-down\"></span> <span>Хвилин</span>\n		</button>\n		<div class=\"uk-dropdown\">\n			<ul class=\"cs-home-add-time-interval uk-nav uk-nav-dropdown\">\n				<li class=\"uk-nav-header\">Одиниці часу</li>\n				<li data-id=\"60\">\n					<a>Хвилин</a>\n				</li>\n				<li data-id=\"3600\">\n					<a>Годин</a>\n				</li>\n				<li data-id=\"86400\">\n					<a>Днів</a>\n				</li>\n			</ul>\n		</div>\n	</div>\n</div>\n<input type=\"text\" class=\"cs-home-add-location-address\" placeholder=\"Адреса або точка на карті\">\n<button class=\"cs-home-add-location uk-icon-location-arrow\"></button>\n<div>\n	<button class=\"cs-home-add-close uk-icon-times\"></button>\n	" + submit + "\n</div>");
      panel.html(content);
      put_events_coords = true;
      map_cursor = map.cursors.push('pointer');
      (function() {
        var uploader_button;
        uploader_button = $('.cs-home-add-image-button');
        return uploader = cs.file_upload(uploader_button, function(files) {
          if (files.length) {
            uploader_button.next('img').remove();
            return uploader_button.after("<img src=\"" + files[0] + "\" alt=\"\" class=\"cs-home-add-image\">");
          }
        });
      })();
      if (edit) {
        $(".cs-home-add-visible [data-id=" + edit_data.visible + "]").click();
        $(".cs-home-add-urgency [data-id=" + edit_data.urgency + "]").click();
        $(".cs-home-add-time").val(edit_data.time).change();
        $(".cs-home-add-time-interval [data-id=" + edit_data.time_interval + "]").click();
        panel.find('textarea').val(edit_data.text);
        add_event_coords([edit_data.lat, edit_data.lng]);
        if (edit_data.img) {
          return $('.cs-home-add-image-button').after("<img src=\"" + edit_data.img + "\" alt=\"\" class=\"cs-home-add-image\">");
        }
      }
    };
    panel.on('click', '> ul > li', addition_editing_panel).on('click', '.cs-home-add-visible [data-id]', function() {
      var $this;
      $this = $(this);
      visible = $this.data('id');
      return $this.parentsUntil('[data-uk-dropdown]').prev().find('span:last').html($this.find('a').text());
    }).on('click', '.cs-home-add-urgency [data-id]', function() {
      var $this;
      $this = $(this);
      urgency = $this.data('id');
      if (urgency === 'unknown') {
        $('.cs-home-actuality-control').hide('fast');
      } else {
        $('.cs-home-actuality-control').show('fast');
      }
      return $this.parentsUntil('[data-uk-dropdown]').prev().find('span:last').html($this.find('a').text());
    }).on('click', '.cs-home-add-time-interval [data-id]', function() {
      var $this;
      $this = $(this);
      time_interval = $this.data('id');
      timeout = $('.cs-home-add-time').val() * time_interval;
      return $this.parentsUntil('[data-uk-dropdown]').prev().find('span:last').html($this.find('a').text());
    }).on('change', '.cs-home-add-time', function() {
      var $this;
      $this = $(this);
      timeout = time_interval * $this.val();
      return $this.parentsUntil('[data-uk-dropdown]').prev().find('span:last').html($this.find('a').text());
    }).on('click', '.cs-home-add-location', function() {
      return alert('Клікніть місце з подією на карті');
    }).on('click', '.cs-home-add-process', function() {
      var comment, img;
      if (category && timeout && coords[0] && coords[1] && urgency) {
        comment = panel.find('textarea').val();
        img = panel.find('.cs-home-add-image');
        return $.ajax({
          url: 'api/Home/events',
          type: 'post',
          data: {
            category: category,
            time: time,
            time_interval: time_interval,
            timeout: timeout,
            lat: coords[0],
            lng: coords[1],
            visible: visible,
            text: comment,
            urgency: urgency,
            img: img ? img.attr('src') : ''
          },
          success: function() {
            panel.hide('fast');
            map.geoObjects.remove(event_coords);
            event_coords = null;
            put_events_coords = false;
            map_cursor.remove();
            map.update_events();
            return alert('Успішно додано, дякуємо вам!');
          }
        });
      } else {
        return alert('Вкажіть точку на карті');
      }
    }).on('click', '.cs-home-edit-process', function() {
      var comment, img;
      if (timeout && coords[0] && coords[1] && urgency) {
        comment = panel.find('textarea').val();
        img = panel.find('.cs-home-add-image');
        return $.ajax({
          url: "api/Home/events/" + edit_data.id,
          type: 'put',
          data: {
            time: time,
            time_interval: time_interval,
            timeout: timeout,
            lat: coords[0],
            lng: coords[1],
            visible: visible,
            text: comment,
            urgency: urgency,
            img: img ? img.attr('src') : ''
          },
          success: function() {
            panel.hide('fast');
            map.geoObjects.remove(event_coords);
            event_coords = null;
            put_events_coords = false;
            map_cursor.remove();
            map.update_events();
            return alert('Успішно відредаговано!');
          }
        });
      } else {
        return alert('Вкажіть точку на карті');
      }
    }).on('keyup change', '.cs-home-add-location-address', function() {
      var $this;
      $this = $(this);
      if ($this.val().length < 4) {
        return;
      }
      clearTimeout(address_timeout);
      return address_timeout = setTimeout((function() {
        return ymaps.geocode($this.val()).then(function(res) {
          coords = res.geoObjects.get(0).geometry.getCoordinates();
          map.panTo(coords, {
            fly: true,
            checkZoomRange: true
          });
          return add_event_coords(coords);
        });
      }), 300);
    });
    return $('#map').on('click', '.cs-home-edit', function() {
      var item;
      item = this;
      return $.ajax({
        url: 'api/Home/events/' + $(this).data('id'),
        type: 'get',
        success: function(data) {
          window.map.balloon.close();
          edit_data = data;
          reset_options();
          panel.show('fast');
          return addition_editing_panel.call(item);
        }
      });
    });
  });

}).call(this);
